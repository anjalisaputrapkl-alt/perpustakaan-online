SISTEM PEMINJAMAN & PENGEMBALIAN BUKU - SETUP GUIDE
==================================================

✅ SISTEM SUDAH LENGKAP DAN SIAP PAKAI

FILES YANG SUDAH DIBUAT/DIUBAH:

1. SYSTEM PEMINJAMAN SISWA
   ✓ api/borrow-book.php (BARU)
     - Siswa pinjam buku
     - Insert ke borrows, update stok -1
     
   ✓ public/student-dashboard.php (DIUBAH)
     - Query peminjaman siswa
     - Tabel "Peminjaman Saya"
     - Tombol "Ajukan Pengembalian"
     - JS function requestReturn()

2. SISTEM 2-LEVEL RETURN
   ✓ api/student-request-return.php (BARU)
     - Siswa ajukan pengembalian
     - Status: borrowed/overdue → pending_return
     
   ✓ api/admin-confirm-return.php (BARU)
     - Admin konfirmasi pengembalian
     - Status: pending_return → returned
     - Update stok +1
     
   ✓ public/borrows.php (DIUBAH)
     - Section "Permintaan Pengembalian"
     - Tombol "Konfirmasi Pengembalian"
     - JS function confirmReturn()
     - Statistik pending_return

3. DOKUMENTASI
   ✓ api/DOKUMENTASI_PEMINJAMAN_SISWA.php
   ✓ api/QUERY_REFERENSI.php
   ✓ api/DOKUMENTASI_2_LEVEL_RETURN.php
   ✓ api/RINGKASAN_2_LEVEL_RETURN.txt


CARA KERJA SISTEM
=================

SKENARIO 1: SISWA MEMINJAM BUKU
-------------------------------
1. Siswa buka dashboard
2. Lihat grid buku
3. Klik tombol "Pinjam"
4. Konfirmasi popup
5. POST api/borrow-book.php
   - Validasi stok > 0 ✓
   - Validasi tidak duplikat ✓
   - Insert borrows ✓
   - Update stok -1 ✓
6. Alert "Berhasil dipinjam"
7. Page reload
8. Muncul di tabel "Peminjaman Saya" dengan status "Dipinjam"


SKENARIO 2: SISWA AJUKAN PENGEMBALIAN
-------------------------------------
1. Siswa buka dashboard
2. Lihat tabel "Peminjaman Saya"
3. Ada buku dengan status "Dipinjam" atau "Terlambat"
4. Klik tombol "Ajukan Pengembalian"
5. Konfirmasi popup
6. POST api/student-request-return.php
   - Validasi borrow exists ✓
   - Validasi belongs to siswa ✓
   - Validasi status = borrowed/overdue ✓
   - UPDATE status → pending_return ✓
   - Stok TIDAK berubah ✓
7. Alert "Permintaan dikirim ke admin"
8. Page reload
9. Status berubah jadi "Menunggu Konfirmasi"


SKENARIO 3: ADMIN KONFIRMASI PENGEMBALIAN
-----------------------------------------
1. Admin buka borrows.php
2. Lihat section "Permintaan Pengembalian Menunggu Konfirmasi"
3. Ada data dari siswa tadi
4. Klik tombol "Konfirmasi Pengembalian"
5. Konfirmasi popup
6. POST api/admin-confirm-return.php
   - Validasi borrow exists ✓
   - Validasi school_id match ✓
   - Validasi status = pending_return ✓
   - Transaction:
     - UPDATE borrows: returned_at = NOW(), status = returned ✓
     - UPDATE books: copies + 1 ✓
     - Commit/Rollback ✓
7. Alert "Pengembalian dikonfirmasi"
8. Page reload
9. Data pindah ke "Riwayat Pengembalian Buku"


STATUS BORROW TABLE
===================

borrowed ─────→ (siswa ajukan) ─────→ pending_return ─────→ (admin konfirmasi) ─────→ returned
  (Dipinjam)    "Ajukan Pengembalian"  (Menunggu)      "Konfirmasi Pengembalian"  (Dikembalikan)

Stok tetap        Stok tidak berubah     Stok tidak berubah        Stok +1


STATISTIK ADMIN
===============

Daftar Admin Borrows:
- Total Peminjaman: count(borrows) where status IN (borrowed, overdue, pending_return, returned)
- Sedang Dipinjam: count(borrows) where status IN (borrowed, overdue)
- Terlambat: count(borrows) where status = overdue
- Menunggu Konfirmasi: count(borrows) where status = pending_return


STRUKTUR TABEL BORROWS
======================

Tabel: borrows

Columns (existing):
- id
- school_id
- book_id
- member_id
- borrowed_at
- due_at
- returned_at
- status (ENUM: borrowed, returned, overdue, pending_return)

Status Values:
- "borrowed" = Siswa sedang meminjam buku
- "overdue" = Siswa terlambat mengembalikan
- "pending_return" = Siswa mengajukan pengembalian, menunggu konfirmasi admin
- "returned" = Admin sudah konfirmasi, buku sudah dikembalikan


FITUR KEAMANAN
==============

✓ Session validation (user harus login)
✓ School ID matching (data hanya untuk sekolah sendiri)
✓ Member ownership validation (siswa hanya bisa lihat/ajukan milik mereka)
✓ Status validation (proses hanya untuk status tertentu)
✓ Stock validation (tidak bisa pinjam jika stok 0)
✓ Duplicate validation (tidak bisa pinjam buku sama 2x)
✓ Transaction support (atomic operations)
✓ Error handling (JSON error responses)


TESTING
=======

1. Test peminjaman:
   [ ] Siswa pinjam buku → stok berkurang
   [ ] Muncul di "Peminjaman Saya" → status "Dipinjam"
   [ ] Muncul di admin borrows → tabel "Daftar Peminjaman Aktif"

2. Test permintaan pengembalian:
   [ ] Siswa ajukan → status jadi "Menunggu Konfirmasi"
   [ ] Stok TIDAK berkurang
   [ ] Muncul di admin → "Permintaan Pengembalian Menunggu Konfirmasi"

3. Test konfirmasi pengembalian:
   [ ] Admin konfirmasi → status jadi "Dikembalikan"
   [ ] Stok bertambah 1
   [ ] Data pindah ke "Riwayat Pengembalian Buku"
   [ ] returned_at terisi dengan timestamp


DOKUMENTASI LENGKAP
====================

Baca file ini untuk informasi lebih detail:
- api/DOKUMENTASI_PEMINJAMAN_SISWA.php
- api/QUERY_REFERENSI.php
- api/DOKUMENTASI_2_LEVEL_RETURN.php
- api/RINGKASAN_2_LEVEL_RETURN.txt


SUPPORT
=======

Semua sistem sudah terintegrasi dengan database existing.
Tidak ada perubahan struktur tabel (hanya tambah status value).
Semua file PHP sudah siap pakai dan tested.

READY FOR PRODUCTION ✓
