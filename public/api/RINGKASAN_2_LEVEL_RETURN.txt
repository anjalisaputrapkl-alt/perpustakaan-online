<?php
/**
 * SISTEM 2-LEVEL RETURN FLOW - RINGKASAN IMPLEMENTASI
 */
?>

================================================================================
SISTEM 2-LEVEL RETURN FLOW - SELESAI âœ“
================================================================================

ğŸ“ FILE YANG DIBUAT/DIUBAH:

1. api/student-request-return.php (BARU)
   âœ“ Siswa mengajukan pengembalian
   âœ“ Status: borrowed/overdue â†’ pending_return
   âœ“ Stok TIDAK berubah

2. api/admin-confirm-return.php (BARU)
   âœ“ Admin mengkonfirmasi pengembalian
   âœ“ Status: pending_return â†’ returned
   âœ“ Isi returned_at = NOW()
   âœ“ Stok +1

3. public/student-dashboard.php (DIUBAH)
   âœ“ Query peminjaman siswa
   âœ“ Tabel "Peminjaman Saya" dengan 4 status
   âœ“ Tombol "Ajukan Pengembalian" (untuk status borrowed/overdue)
   âœ“ CSS: .btn-return-request (warna orange/warning)
   âœ“ JS: function requestReturn(borrowId)

4. public/borrows.php (DIUBAH)
   âœ“ Section "Permintaan Pengembalian Menunggu Konfirmasi"
   âœ“ Statistik: Menunggu Konfirmasi counter
   âœ“ Filter aktif: exclude pending_return & returned
   âœ“ CSS: .status-pending, .btn-confirm-return (warna cyan)
   âœ“ JS: function confirmReturn(borrowId)


================================================================================
FITUR SISTEM
================================================================================

SISWA:
------
âœ“ Lihat tabel peminjaman dengan status:
  - Dipinjam (biru)
  - Terlambat (merah)
  - Menunggu Konfirmasi (kuning/orange)
  - Dikembalikan (hijau)

âœ“ Tombol "Ajukan Pengembalian" untuk status Dipinjam/Terlambat
  - Klik â†’ Konfirmasi popup
  - POST ke api/student-request-return.php
  - Status berubah jadi "Menunggu Konfirmasi"
  - Stok buku TETAP (tidak berkurang)

ADMIN:
------
âœ“ Lihat 3 section peminjaman:
  1. Permintaan Pengembalian Menunggu Konfirmasi (pending_return)
  2. Daftar Peminjaman Aktif (borrowed/overdue)
  3. Riwayat Pengembalian Buku (returned)

âœ“ Section 1 (Pending Return):
  - Tombol "Konfirmasi Pengembalian" (cyan/biru)
  - Klik â†’ Konfirmasi popup
  - POST ke api/admin-confirm-return.php
  - Status â†’ "Dikembalikan"
  - Stok +1
  - Data pindah ke section 3 (Riwayat)
  - returned_at auto-filled = NOW()


================================================================================
FLOW DIAGRAM
================================================================================

TAHAP 1: SISWA
--------------
Dashboard Siswa
  â†“
Lihat tabel "Peminjaman Saya" (status = borrowed/overdue)
  â†“
Klik "Ajukan Pengembalian"
  â†“
Konfirmasi popup
  â†“
POST api/student-request-return.php
  â†“
Validasi âœ“
  â†“
UPDATE borrows SET status = "pending_return"
  â†“
Return success
  â†“
Alert "Permintaan dikirim ke admin"
  â†“
Refresh page â†’ Status = "Menunggu Konfirmasi"


TAHAP 2: ADMIN
--------------
Dashboard Admin (borrows.php)
  â†“
Lihat section "Permintaan Pengembalian Menunggu Konfirmasi"
  â†“
Klik "Konfirmasi Pengembalian"
  â†“
Konfirmasi popup
  â†“
POST api/admin-confirm-return.php
  â†“
Validasi âœ“
  â†“
BEGIN TRANSACTION
  â†“
UPDATE borrows SET returned_at=NOW(), status="returned"
  â†“
UPDATE books SET copies=copies+1
  â†“
COMMIT
  â†“
Return success
  â†“
Alert "Pengembalian dikonfirmasi!"
  â†“
Refresh page â†’ Data pindah ke "Riwayat Pengembalian"


================================================================================
STATUS BORROW
================================================================================

Status | Warna | Deskripsi | Aksi Siswa | Aksi Admin
-------|-------|-----------|------------|----------
borrowed | Biru | Dipinjam | Ajukan Pengembalian | Tunggu request
overdue | Merah | Terlambat | Ajukan Pengembalian | Tunggu request
pending_return | Orange | Menunggu Konfirmasi | Tunggu admin | Konfirmasi
returned | Hijau | Dikembalikan | - | -


================================================================================
KEAMANAN & VALIDASI
================================================================================

Student Request Return (api/student-request-return.php):
âœ“ Validasi authentication (session)
âœ“ Validasi borrow_id valid
âœ“ Validasi borrow exists
âœ“ Validasi borrow belong to student (member_id = session user)
âœ“ Validasi status = borrowed/overdue (reject jika pending/returned)
âœ“ Validasi school_id match
âœ“ Error handling JSON

Admin Confirm Return (api/admin-confirm-return.php):
âœ“ Validasi authentication (requireAuth)
âœ“ Validasi borrow_id valid
âœ“ Validasi school_id match
âœ“ Validasi borrow exists
âœ“ Validasi status = pending_return (reject jika status changed)
âœ“ Transaction dengan rollback
âœ“ Error handling JSON


================================================================================
DATABASE CHANGES
================================================================================

BORROWS TABLE - TAMBAHAN STATUS:
- pending_return: Status baru saat siswa mengajukan pengembalian

TIDAK ADA perubahan struktur tabel, hanya tambah status value.


================================================================================
TESTING CHECKLIST
================================================================================

[ ] Siswa buka dashboard â†’ lihat tabel peminjaman
[ ] Status "Dipinjam" tampil dengan warna biru
[ ] Status "Terlambat" tampil dengan warna merah
[ ] Status "Menunggu Konfirmasi" tampil dengan warna orange
[ ] Status "Dikembalikan" tampil dengan warna hijau
[ ] Tombol "Ajukan Pengembalian" ada untuk Dipinjam/Terlambat
[ ] Tombol "Ajukan Pengembalian" TIDAK ada untuk pending/returned
[ ] Klik ajukan â†’ konfirmasi popup
[ ] Klik OK â†’ POST ke API
[ ] Status berubah jadi "Menunggu Konfirmasi"
[ ] Stok buku tidak berkurang

[ ] Admin buka borrows.php â†’ lihat 3 section
[ ] Section "Permintaan Pengembalian" tampil dengan data pending
[ ] Tombol "Konfirmasi Pengembalian" (cyan) ada di setiap row
[ ] Klik konfirmasi â†’ popup
[ ] Klik OK â†’ POST ke API
[ ] Status berubah jadi "Dikembalikan"
[ ] Data pindah ke "Riwayat Pengembalian"
[ ] Stok buku bertambah 1
[ ] returned_at terisi dengan timestamp saat ini

[ ] Test: Siswa request return, refresh â†’ status tetap pending
[ ] Test: Admin konfirmasi, refresh â†’ status jadi returned
[ ] Test: Stok awal, siswa ajukan, stok tetap, admin confirm, stok +1


================================================================================
CATATAN PENTING
================================================================================

âœ“ Sistem terintegrasi penuh dengan database existing
âœ“ Tidak ada perubahan struktur tabel
âœ“ UI student dashboard tetap (hanya tambah tabel peminjaman)
âœ“ UI admin borrows tetap (hanya tambah section & tombol)
âœ“ Semua data terupdate otomatis saat refresh
âœ“ Menggunakan AJAX untuk smooth experience
âœ“ Transaction-based untuk consistency
âœ“ Full validation & error handling

